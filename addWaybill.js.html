<script> 
	
    $(document).ready(function() {
    
        // color a table row background
        $("#products_table tbody tr").click(setBackground);
        
        // remove the .selected class from the row, detach it and append to the #selected_products_table. 
        $("#products_table tbody tr").dblclick(appendToSelectedProducts);
        
        $("#add_waybills_button").click(processProducts);
        
        $("#spinner").hide();
    });
    
 /**
 * Remove a row from the products table to append it into the selected products table
 */
    function appendToSelectedProducts() {
    
        // remove the background
        $(this).removeClass('selected');
        
        // detach the row from the products table, append a td with an input on it and append the row to #selected_products table.
        // set double click event to append the row to products.
        // set click event to set/unset the background
        $(this).detach().clone().append('<td><input type="number"/></td>').appendTo('#selected_products_table')
                 .addClass('waybill_product')
                 .dblclick(appendToProducts)
                 .click(setBackground);
         
        // increase the amount of selected products  
        $("#selected_products_count").text(parseInt($("#selected_products_count").text())+1);
    }
   
   /**
 * Remove a row from the selected products table to append it into the products table
 */
    function appendToProducts() {
    
        // remove the input td
        $(this).find("td:last").remove();
        
        // detach the row from the selected products table, remove the last td and append it to the #products table.
        $(this).detach().clone().appendTo('#products_table').dblclick(appendToSelectedProducts);    
        
        // decrease the amount of selected products
        $("#selected_products_count").text(parseInt($("#selected_products_count").text())-1);
    }

 /** 
 * Creates a array with the table information and calls the google app script function to process the spreadsheet
 */
    function processProducts() {
 
       if (validateForm()) {
       
       // create flags to validate the products
       var areProductsValidated = true;
       var noProducts = true;
       
       // get the values
       var waybillNumber = $("#waybill_number").val();
       var waybillDate = $("#waybill_date").val();
       var store = $("#stores").find(":selected").text();      
 
        // Iterate each .waybill_product tr 
        var waybill = [];
        $(".waybill_product").each(function(index) {

         noProducts = false;

         //get the name, size and amount
         var id = $(this).find("td")[0].innerHTML;
         var name = $(this).find("td")[1].innerHTML;
         var size = $(this).find("td")[2].innerHTML;
         var inventory = $(this).find("td")[3].innerHTML;
         var amount = $(this).find("td:last input").val();

          inventory = parseInt(inventory);
          amount = parseInt(amount);
         
         //validate the amount greater than zero
         if (!amount || amount <= 0) {
         
            $("#add_waybills_button").removeAttr('disabled');
            alert("La cantidad ingresada de " + name + " " + size + " debe ser mayor a 0.");
            areProductsValidated = false;
            return false;
         }
         
         
         // validate the amount less or equal to the inventory
         if (amount > inventory) {
            
            $("#add_waybills_button").removeAttr('disabled');
            alert("La cantidad ingresada de " + name + " " + size + " no puede ser mayor al inventario.");
            areProductsValidated = false;
            return false;
         }
         
         var product = {};
         
         // set the product object
         product.waybillNumber = waybillNumber;
         product.waybillDate = waybillDate;
         product.store = store;
         product.id = id;
         product.name = name;
         product.size = size;
         product.amount = amount;
         
         // add the object to array
         waybill[index] = product;
            
        });
        
        // validate at least one product selected
        if (noProducts) {
        
            $("#add_waybills_button").removeAttr('disabled');
            alert("Debe seleccionar al menos un producto.");
            areProductsValidated = false;
        }
        
       // process the waybill
       if (areProductsValidated) {
       
          $("#spinner").show();
          
           google.script.run
           .withSuccessHandler(addWaybillSuccessHandler)
           .withFailureHandler(addWaybillFailureHandler)
           .addWaybill(waybill);
        }
      }
    }
    
    
    function validateForm() {
    
      // get the values
       var waybillNumber = $("#waybill_number").val();
       var waybillDate = $("#waybill_date").val();
       var store = $("#stores").find(":selected").text();
 
      // validate non-empty and greater than zero waybill number.
      if (!waybillNumber || waybillNumber <= 0) {
         
         $("#add_waybills_button").removeAttr('disabled');
         alert("El número de guía de despacho debe ser mayor a cero.");
         return false;
      }
      
      // validate non-empty and greater than zero waybill date.
      if (!waybillDate || waybillDate <= 0) {
         
         $("#add_waybills_button").removeAttr('disabled');
         alert("Debe seleccionar una fecha para la Guía de despacho.");
         return false;
      }
      
      // validate non-empty and greater than zero waybill number.
      if (!store) {
         
         $("#add_waybills_button").removeAttr('disabled');
         alert("Debe seleccionar una tienda para la Guía de despacho.");
         return false;
      }
      
      return true;
    
    }


   function addWaybillSuccessHandler(response) {
   
   if (response == -1) {
   
    var waybillNumber = $("#waybill_number").val();
    alert("La Guía " + waybillNumber + " ya existe o fue anulada.");
    $("#spinner").hide();
    $("#add_waybills_button").removeAttr('disabled');
   
   } else {
   
    alert("Ingreso de la guía de despacho exitoso.");
    google.script.host.close();
   
   }
    
  };
  
  function addWaybillFailureHandler() {
    alert("El ingreso de la guía de despacho falló. Intente nuevamente.");
    $("#spinner").hide();
    $("#add_waybills_button").removeAttr('disabled');
  }
  
</script>
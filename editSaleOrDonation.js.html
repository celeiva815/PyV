<script> 
	
    
    $(document).ready(function() {
    
        $("#chargeback_reason").hide(); 
        
        // set the events for the radio button
        $('input[type=radio][name=bill]').change(function () {
            if (this.value == 'invoice') {
                          
            }
            if (this.value == 'receipt') {
                
            }
            if (this.value == 'donation') {
                
            }
        });
        
        $("#edit_receipt_or_invoice_button").click(processProducts);
        $("#spinner").hide();
        
    });

 /** 
 * Creates a array with the table information and calls the google app script function to process the spreadsheet
 */
    function searchProducts() {
     
        searchDonatedProducts();
    }

     /** 
 * Creates a array with the table information and calls the google app script function to process the spreadsheet
 */
    function searchDonatedProducts() {
     
        // get the invoice id 
        var invoiceId = $("#invoice_id").val();
        
        // run the server-side function to get the products.
        google.script.run.withSuccessHandler(searchDonatedProductsSuccessHandler).getDonatedProducts(invoiceId);     
    }


/**
* Receives the products found when searching products.
*/
  function searchDonatedProductsSuccessHandler(products) {
    
     var json = JSON.parse(products);
     var tbody = $('#products_table tbody');
     var recipientName = "";
     var date = "";
     var bill = "";
     
     // clear the previous content
     $(tbody).empty();
     
     // add each item to the tbody
     $.each(json, function(i, product) {
     
        console.log(product);
         
         var productId = product[0];
         var productName = product[1];
         var productSize = product[2];
         var productAmount = product[6];
         var productInventory = product[7];
         
         var tdChange = "<td><input id='product_"+productId+"' type='number'/></td>"
         
         var tr = "<tr class='change_product'><td>"+productId+"</td><td>"+productName+"</td><td>"+productSize+"</td><td>"+productAmount+"</td><td>"+productInventory+"</td>"+tdChange+"</tr>";
         
         tbody.append(tr);
         
         recipientName = product[3];
         date = product[5];
         bill = product[4];
         
      });
      
      // set the recipient
      $("#recipients").val(recipientName);
      
      var newDate = new Date(Date.parse(date));
      newDate.setHours(24);
      document.getElementById("invoice_date").valueAsDate = newDate;
      
      // set the bill
      if (bill == "Boleta") {
        $("input[name=bill][value='receipt']").prop("checked",true);
      }
      
      if (bill == "Factura") {
        $("input[name=bill][value='invoice']").prop("checked",true);
      }
      
      if (bill == "Donación") {
        $("input[name=bill][value='donation']").prop("checked",true);
      }
      
      
  };
  
  
  /** 
 * Creates a array with the table information and calls the google app script function to process the spreadsheet
 */
    function processProducts() {
       
       if (validateForm()) {
       
       // create flags to validate the products
       var areProductsValidated = true;
       var noProducts = true;
       var productsIndex = 0;
       
       // get the values
       var billDate = $("#invoice_date").val();
       var billId = $("#invoice_id").val();
       var store = $("#recipients").val();
       var billType = $('input[name=bill]:checked').val();
       
        // Iterate each .waybill_product tr 
        var bill = [];
        $(".change_product").each(function(index) {

         noProducts = false;

         //get the name, size and amount
         var id = $(this).find("td")[0].innerHTML;
         var name = $(this).find("td")[1].innerHTML;
         var size = $(this).find("td")[2].innerHTML;
         var invoiceStock = $(this).find("td")[3].innerHTML;
         var inventory = $(this).find("td")[4].innerHTML;
         var amount = $(this).find("td:last input").val();

          inventory = parseInt(inventory);
          amount = parseInt(amount);
          invoiceStock = parseInt(invoiceStock);
         
         //validate the amount greater than zero to change only the products edited.
         if (amount > 0) {
         
           var difference = amount - invoiceStock;
         
           // validate the amount less or equal to the inventory
           if (difference > inventory) {
         
              $("#edit_receipt_or_invoice_button").removeAttr('disabled');
              alert("La cantidad ingresada de " + name + " " + size + " no puede ser mayor al inventario.");
              areProductsValidated = false;
              return false;
           }
         
           var product = {};
         
           // set the product object
           product.billDate = billDate;
           product.billId = billId;
           product.store = store;
           product.id = id;
           product.name = name;
           product.size = size;
           product.amount = amount;
           product.inventory = inventory;
           product.invoiceStock = invoiceStock;
           product.billType = billType;  
           
           // add the object to array
           bill[productsIndex] = product;
           productsIndex++;
           
          }
            
        });
        
        // validate at least one product selected
        if (noProducts) {
        
            $("#edit_receipt_or_invoice_button").removeAttr('disabled');
            alert("Debe seleccionar al menos un producto.");
            areProductsValidated = false;
        }
        
       // process the waybill
       if (areProductsValidated) { 
          
          $("#spinner").show();
          
           google.script.run
           .withSuccessHandler(editSaleOrDonationProductsSuccessHandler)
           .withFailureHandler(editSaleOrDonationProductsFailureHandler)
           .editSaleOrDonation(bill);
        }
      }

    }
  
  
  function validateForm() {
    
      // get the values
       var invoiceNumber = $("#invoice_id").val();
       var invoiceDate = $("#invoice_date").val();
       var store = $("#recipients").val();
       var billType = $('input[name=bill]:checked').val();
 
      // validate non-empty and greater than zero waybill number.
      if (!invoiceNumber) {
         
         $("#edit_receipt_or_invoice_button").removeAttr('disabled');
         alert("Debe ingresar un número de Factura, Boleta o Donación.");
         return false;
      }
      
      // validate non-empty and greater than zero waybill date.
      if (!invoiceDate || invoiceDate <= 0) {
         
         $("#edit_receipt_or_invoice_button").removeAttr('disabled');
         alert("Debe seleccionar una fecha para la Factura, Boleta o Donación.");
         return false;
      }
      
      // validate non-empty and greater than zero waybill number.
      if (!store) {
         $("#edit_receipt_or_invoice_button").removeAttr('disabled');
         alert("Debe seleccionar una tienda para a Factura, Boleta o Donación.");
         return false;
      }
      
      // validate non-empty bill type.
      if (!billType) {
         $("#edit_receipt_or_invoice_button").removeAttr('disabled');
         alert("Debe seleccionar si es boleta, factura o donación.");
         return false;
      }
      
      return true;
    
    }
    
    
  function editSaleOrDonationProductsSuccessHandler(response) {
  
    $("#spinner").hide();
    alert("La edición de la venta o donación fue realizada exitosamente.");
    google.script.host.close();
    
  }
  
  function editSaleOrDonationProductsFailureHandler(response) {
    
    $("#spinner").hide();
    $("#edit_receipt_or_invoice_button").removeAttr('disabled');
    alert("La edición de la venta o donación falló.");
  }
    

</script>